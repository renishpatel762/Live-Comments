events {}

http {
    upstream comment_streaming_service {
         # These names should match the container names or aliases from the publisher service.
        # If using swarm DNS, you can use the service name.
        server comment_streaming:5000;
        # Additional replicas would be resolved automatically if using swarm or an external DNS.
        # ip_hash; 
        # sticky connection
    }

    server {
        listen 80;

        location / {
            # Pass requests to the backend service
            proxy_pass http://comment_streaming_service;

            # Use HTTP/1.1 for persistent connections
            proxy_http_version 1.1;
            proxy_set_header Connection "keep-alive";
            proxy_set_header Host $host;

            # Disable buffering for SSE
            proxy_buffering off;
            proxy_cache off;

            # Increase timeouts for long-lived SSE connections
            proxy_read_timeout 3600;
            # 3600 seconds = 1 hour

            # Forward additional headers if needed
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
